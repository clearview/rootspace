version: 0.2
env:
  variables:
    AWS_REGION: eu-west-1
    API_REPOSITORY: rootspace_ecr/api
    WEB_REPOSITORY: rootspace_ecr/web
  parameter-store:
    API_ENDPOINT: "api_app_runner_endpoint"
  exported-variables: # Export vars to CodePipeline
    - API_ENDPOINT
phases:
    # install:
    #     commands:
    #         - echo Starting the Docker daemon...
    #         - /usr/local/bin/dockerd-entrypoint.sh
    pre_build:
        commands:
            - aws --version
            - docker --version
            - mkdir test
            - touch test/test.txt
            - aws s3 sync test s3://rootspace-web/test/
    build:
        commands:
            #
            # .ENV foe WEB
            #
            - pwd
            - cd web
            - 'echo API_ENDPOINT=https://$API_ENDPOINT>>./.env'
            - 'echo VUE_APP_YWS_URL=ws://localhost:6001>>./.env'
            #
            # Docker for WEB
            #
            - cd $CODEBUILD_SRC_DIR
            - pwd
            - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin 207259804926.dkr.ecr.$AWS_REGION.amazonaws.com
            - aws ecr create-repository --repository-name $WEB_REPOSITORY --region $AWS_REGION || true
            - docker build .
              --tag 207259804926.dkr.ecr.$AWS_REGION.amazonaws.com/rootspace_ecr/web:latest
              --file ./infra/docker/Dockerfile.web
            - docker push 207259804926.dkr.ecr.$AWS_REGION.amazonaws.com/rootspace_ecr/web:latest
            #
            # Build for WEB, needed for S3
            #
            - cd $CODEBUILD_SRC_DIR
            - pwd
            - cd web
            - echo "Installing packages... $(yarn install)"
            - echo "Building web...  $(yarn build)"
            #
            #
            # Docker for API
            #
            - cd $CODEBUILD_SRC_DIR
            - pwd
            - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin 207259804926.dkr.ecr.$AWS_REGION.amazonaws.com
            - aws ecr create-repository --repository-name $API_REPOSITORY --region $AWS_REGION || true
            - docker build .
              --tag 207259804926.dkr.ecr.$AWS_REGION.amazonaws.com/rootspace_ecr/api:latest
              --file ./infra/docker/Dockerfile.api
            - docker push 207259804926.dkr.ecr.$AWS_REGION.amazonaws.com/rootspace_ecr/api:latest
    post_build:
        commands:
            - pwd
            - cd $CODEBUILD_SRC_DIR/web
            - aws s3 sync ./dist s3://rootspace-web
